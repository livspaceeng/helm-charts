{{- if .Values.externalSecretsv2.enabled }}

{{- $environment := ((.Values.global).environment) | default (.Release.Namespace | regexFind "^(prod|staging|stage)" | default "staging") }}

{{- $secretStore := eq $environment "prod" | ternary "gcpsm-prod" "gcpsm-staging" }}

{{- range .Values.externalSecretsv2.secrets }}

{{- $secretName := .name }}
{{- $format := .format | default "keyvalue" }}
{{- $refreshInterval := .refreshInterval | default $.Values.externalSecretsv2.refreshInterval | default "1h" }}
{{- $version := .version | default "" }}

# Use full secret name directly (e.g., "default-infra-database-creds")
{{- $secretNamePath := $secretName }}

---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ $secretNamePath }}-secret
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "application.labels" $ | nindent 4 }}
    secret-management.livspace.com/version: v2
    secret-management.livspace.com/environment: {{ $environment }}
    secret-management.livspace.com/secret-name: {{ $secretNamePath }}
  annotations:
    secret-management.livspace.com/secret-path: {{ $secretNamePath }}
    {{- if .annotations }}
    {{- toYaml .annotations | nindent 4 }}
    {{- end }}
spec:
  refreshInterval: {{ $refreshInterval }}
  secretStoreRef:
    name: {{ .secretStore | default $secretStore }}
    kind: ClusterSecretStore
  target:
    name: {{ $secretNamePath }}-secret
    creationPolicy: Owner
    {{- if .deletionPolicy }}
    deletionPolicy: {{ .deletionPolicy }}
    {{- end }}
    {{- if .template }}
    template:
      {{- toYaml .template | nindent 6 }}
    {{- end }}
  {{- if eq $format "string" }}
  data:
  - secretKey: {{ .secretKey | default "value" }}
    remoteRef:
      key: {{ $secretNamePath }}
    {{- if $version }}
      version: "{{ $version }}"
    {{- end }}
    {{- if .conversionStrategy }}
      conversionStrategy: {{ .conversionStrategy }}
    {{- end }}
    {{- if .decodingStrategy }}
      decodingStrategy: {{ .decodingStrategy }}
    {{- end }}
  {{- else }}
  dataFrom:
  - extract:
      key: {{ $secretNamePath }}
    {{- if $version }}
      version: "{{ $version }}"
    {{- end }}
      {{- if .rewrite }}
      rewrite:
        {{- toYaml .rewrite | nindent 8 }}
      {{- end }}
      {{- if .conversionStrategy }}
      conversionStrategy: {{ .conversionStrategy }}
      {{- end }}
      {{- if .decodingStrategy }}
      decodingStrategy: {{ .decodingStrategy }}
      {{- end }}
  {{- end }}

{{- end }}
{{- end }}
